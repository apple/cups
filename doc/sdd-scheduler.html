<HTML>
<HEAD>
    <META NAME="Description" CONTENT="Common UNIX Printing System Software Design Description">
    <META NAME="COPYRIGHT" CONTENT="Copyright 1997-1998, All Rights Reserved">
    <META NAME="DOCNUMBER" CONTENT="CUPS-SDD-SCHED-1.0">
    <META NAME="Author" CONTENT="Easy Software Products">
    <TITLE>DRAFT - CUPS Print Scheduler Software Design Description - DRAFT</TITLE>
</HEAD>
<BODY>

<H1>Scope</H1>

<H2>Identification</H2>

This software design description document provides detailed
information  on the architecture and coding of the Common UNIX Printing
System (&quot;CUPS<SUP>TM</SUP>&quot;) print scheduler, Version 1.0.

<H2>System Overview</H2>

The Common UNIX Printing System provides a portable printing layer for 
UNIX&reg; operating systems. It has been developed by Easy Software 
Products to promote a standard printing solution for all UNIX vendors 
and users. CUPS provides the System V, Berkeley, and POSIX
command-line interfaces.

<P>CUPS uses the Internet Printing Protocol (IETF-IPP) as the basis
for managing print jobs and queues. The Line Printer Daemon  (LPD,
RFC1179), Server Message Block (SMB), and AppSocket protocols are also
supported with reduced functionality.

<P>CUPS adds network printer browsing and PostScript Printer
Description (&quot;PPD&quot;)-based printing options to support real
world applications under UNIX.

<H2>Document Overview</H2>

This software design description document is organized into the 
following sections:

<UL>
	<LI>1 - Scope 
	<LI>2 - References 
	<LI>3 - Preliminary Design 
	<LI>4 - Detailed Design 
	<LI>A - Glossary 
</UL>

<H1>References</H1>

<H2>CUPS Documentation</H2>

The following CUPS documentation is referenced by this document:

<UL>
	<LI>CUPS-BACKEND-SDD-1.0: CUPS Backend Software Design Description 
	<LI>CUPS-BSD-SDD-1.0: CUPS Berkeley Interface Software Design Description 
	<LI>CUPS-CMP-1.0: CUPS Configuration Management Plan 
	<LI>CUPS-FILTER-SDD-1.0: CUPS Filter Software Design Description 
	<LI>CUPS-GUI-SDD-1.0: CUPS Graphical User-Interface Software Design Description 
	<LI>CUPS-IDD-1.0: CUPS System Interface Design Description 
	<LI>CUPS-POSIX-SDD-1.0: CUPS POSIX Interface Software Design Description 
	<LI>CUPS-SAM-1.0.0: CUPS Software Administrators Manual 
	<LI>CUPS-SCHED-SDD-1.0: CUPS Print Scheduler Software Design Description 
	<LI>CUPS-SPM-1.0: CUPS Software Programming Manual
	<LI>CUPS-SSDD-1.0: CUPS System-Subsystem Design Description 
	<LI>CUPS-SSR-1.0: CUPS Software Security Report 
	<LI>CUPS-STP-1.0: CUPS Software Test Plan 
	<LI>CUPS-SUM-1.0.0: CUPS Software Users Manual 
	<LI>CUPS-SVD-1.0.0: CUPS Software Version Description 
	<LI>CUPS-SYSV-SDD-1.0: CUPS System V Interface Software Design Description 
</UL>

<H2>Other Documents</H2>

The following non-CUPS documents are referenced by this document:

<UL>
	<LI>IEEE 1387.4, System Administration: Printing (draft) 
	<LI>IPP/1.0: Additional Optional Operations - Set 1
	<LI>IPP/1.0: Encoding and Transport
	<LI>IPP/1.0: Implementers Guide
	<LI>IPP/1.0: Model and Semantics
	<LI>RFC 1179, Line Printer Daemon Protocol 
</UL>

<H1>Preliminary Design</H1>

<H2 VALUE="0">Sub-System Overview</H2>

The CUPS print scheduler is composed of four software sub-systems that 
operate together to handle all printer management and queuing functions 
of CUPS and maintain a database of available local and remote printers 
and classes:

<UL>
	<LI>Command Processing 
	<LI>Job Processing 
	<LI>CUPS Interface 
	<LI>CUPS Directory Service 
</UL>

<H2>Command Processing</H2>

The following commands are understood by the <I>command</I> <I>processing</I>
 sub-system. Each command sends a response back to the <I>CUPS 
interface </I>sub-system indicating the success or failure of the 
command, plus any additional data specific to the command. </P>

<H3 TYPE="a">Add Printer</H3>

The <I>add printer</I> command adds the specified printer to the list 
of available local printers. The printer name, universal resource 
identifier (&quot;URI&quot;), interface script, PPD file, class(es), 
and location information are provided in this message. </P>
<P>
This command requires administrative priviledges. </P>
<H3>
Remove Printer</H3>
<P>
The <I>remove printer</I> command removes the specified printer from 
the list of available local printers. The printer name is provided in 
this message. </P>
<P>
This command requires administrative priviledges. </P>
<H3>
Update Printer</H3>
<P>
The <I>update printer</I> command reconfigures the specified local 
printer. The printer name, universal resource locator 
(&quot;URL&quot;), interface script, PPD file, class(es), and location 
information are provided in this message. </P>
<P>
This command requires administrative priviledges. </P>
<H3>
Query Printer</H3>
<P>
The <I>query printer</I> command returns the current configuration of 
the specified local printer. The printer name is provided in this 
message. </P>
<H3>
Find Printers</H3>
<P>
The <I>find printer</I> command returns zero or more printers that 
match the specified printer name, class, location, and capabilities.</P>
<H3>
Queue File</H3>
<P>
The <I>queue file</I> command queues a file for printing to the 
specified printer or class. The printer or class name, filename, title, 
priority, number of copies, and option(s) are provided in this message. </P>
<H3>
Unqueue File</H3>
<P>
The <I>unqueue file</I> command removes a file from the print queue if 
it is queued or printing. The printer or class name and filename are 
provided in this message. </P>
<P>
You must be the queuer of the file or have administrative priviledges 
to use this command. </P>
<H3>
Requeue File</H3>
<P>
The <I>requeue file</I> command moves a file for printing to the 
specified printer or class. The printer or class name, priority, number 
of copies, and filename are provided in this message. </P>
<P>
You must be the queuer of the file or have administrative priviledges 
to use this command. </P>
<H3>
Get Printer Status</H3>
<P>
The <I>get printer status</I> command returns the current printer 
status of the specified printer. The printer name is provided in this 
message. </P>
<H3>
Set Printer Status</H3>
<P>
The <I>set printer status</I> command sets the current printer status 
of the specified printer. The printer name, status code, and status 
text is provided in this message. </P>
<P>
This command requires administrative priviledges. </P>
<H3>
Get Printer Access</H3>
<P>
The <I>get printer access</I> command gets the page/access limits for a 
printer and/or user. </P>
<H3>
Set Printer Access</H3>
<P>
The <I>set printer access</I> command sets the page/access limits for a 
printer and/or user. </P>
<P>
This command requires administrative priviledges. </P>
<H3>
Get PPD File</H3>
<P>
The <I>get ppd file</I> command returns the PPD file for the specified 
printer. The printer name is provided in this message. </P>
<H3>
Get Queue Status</H3>
<P>
The <I>get queue status</I> command returns the current list of files 
queued for printing on the specified printer or class. The printer or 
class name is provided in this message. </P>
<H3>
Get Default Options</H3>
<P>
The <I>get default options</I> command returns the current default 
options for the specified printer. The printer name is provided in this 
message. </P>
<H3>
Set Default Options</H3>
<P>
The <I>set default options</I> command sets the current default options 
for the specified printer. The printer name and options are provided in 
this message. </P>
<H3>
Get Page List</H3>
<P>
The <I>get page list</I> command returns a list of pages sent to the 
specified printer. You can optionally send user or group names and a 
date/time range to restrict the pages returned. </P>
<H3>
Clear Page List</H3>
<P>
The <I>clear page list</I> command clears the page list for the 
specified printer. </P>
<P>
This command required administrative priviledges. </P>
<H3>
Check Pages</H3>
<P>
The <I>check pages</I> command checks to see if the specified user can 
print another page to the specified printer. </P>
<H3>
Log Page</H3>
<P>
The <I>log page</I> command logs that a page has been printed on the 
specified printer. The printer name, job ID, job title, username, and 
print type/options are send in this message. </P>
<H2>
Job Processing</H2>
<P>
Files are processed in round-robin fashion based upon the job priority 
and order of queuing. Files queued to a specific printer have a higher 
priority than files queued to a printer class with the same priority. </P>
<P>
Each file is printed by executing a series of filters and piping the 
output into a device-specific &quot;driver&quot; program that sends the 
standard input to the output device. A MIME-based conversion database 
is used to determine which filters to use to convert from the print 
file format to the output device format.</P>
<P>
The baseline CUPS distribution will have &quot;drivers&quot; for 
locally connected serial, parallel, and SCSI devices, as well as 
network drivers for FTP, HTTP (IPP), LPD, Reverse TELNET, SMB, TELNET, 
and TFTP protocols.</P>
<H2>
CUPS Interface</H2>
<P>
The <I>CUPS interface </I>sub-system provides a common interface 
between the scheduler and any client applications. It utilizes a 
library of functions that is defined in the CUPS Interface Design 
Description, 1.0 (CUPS-IDD-1.0).</P>
<P>
Connections to the scheduler are filtered based upon an access control 
list (ACL). The scheduler ACL also is used to limit access to specific 
commands once the connection is active.</P>
<H2>
CUPS Directory Service</H2>
<P>
The <I>CUPS directory service </I>sub-system handles the sending and 
reception of printer information that is broadcast on the LAN. The type 
and frequency of these updates can be controlled through the scheduler 
ACL file. Incoming printer information is used to maintain the 
scheduler's internal list of printers that are available on the network.</P>
<P>
Three types of broadcast messages will be sent/received:</P>
<UL>
    <LI>
    Add printer to list 
    <LI>
    Update printer in list 
    <LI>
    Delete printer from list 
</UL>
<P>
Each message contains the message type, printer capabilities (color, 
duplexing, small/media/large format), printer/class name, printer 
status code, and any status text associated with the printer 
(&quot;down for maintenance&quot;, &quot;printing page 1&quot;, etc.)</P>
<H1>
Detailed Design</H1>
<H2>
Command Processing</H2>
<P>
The <I>scheduler</I> sub-system is composed of ??? functions that 
perform the four tasks outlined in Section 3.1: <BR>
&nbsp; </P>
<CENTER>
<TABLE BORDER="1" WIDTH="80%">
    <TR>
        <TH>Task</TH>
        <TH>Function</TH>
    </TR>
    <TR>
        <TD>Command Processing</TD>
        <TD>CommandProcessing()</TD>
    </TR>
    <TR>
        <TD>Local Queue Processing</TD>
        <TD>LocalProcessing()</TD>
    </TR>
    <TR>
        <TD>Remote Queue Processing</TD>
        <TD>RemoteProcessing()</TD>
    </TR>
    <TR>
        <TD>Network Information Processing</TD>
        <TD>NetworkProcessing()</TD>
    </TR>
</TABLE>
</CENTER>
<P>
These functions are called by the main() function when new data or 
connections are detected. The main() function uses the select() system 
call to minimize CPU usage. </P>
<H3>
Global Variables</H3>
<P>
The following global state variables are maintained by the <I>scheduler</I>
 sub-systems: <BR>
&nbsp; </P>
<CENTER>
<TABLE BORDER="1" WIDTH="80%">
    <TR>
        <TH>Variable</TH>
        <TH>Type</TH>
        <TH>Description</TH>
    </TR>
    <TR>
        <TD>InputSet</TD>
        <TD>fd_set</TD>
        <TD>Input set for select() in the main() function.</TD>
    </TR>
    <TR>
        <TD>OutputSet</TD>
        <TD>fd_set</TD>
        <TD>Output set for select() in the main() function.</TD>
    </TR>
    <TR>
        <TD>CommandListenSocket</TD>
        <TD>int</TD>
        <TD>A socket that listens for new connections from local 
            clients.</TD>
    </TR>
    <TR>
        <TD>CommandSockets</TD>
        <TD>int [MAX_CLIENTS]</TD>
        <TD>Active local client sockets.</TD>
    </TR>
    <TR>
        <TD>NumCommandSockets</TD>
        <TD>int</TD>
        <TD>The number of local clients currently connected.</TD>
    </TR>
    <TR>
        <TD>InfoSockets</TD>
        <TD>int [MAX_INTERFACES]</TD>
        <TD>Sockets that listen for network updates of printers.</TD>
    </TR>
    <TR>
        <TD>NunInfoSockets</TD>
        <TD>int [MAX_INTERFACES]</TD>
        <TD>Sockets that listen for network updates of printers.</TD>
    </TR>
    <TR>
        <TD>RemoteListenSocket</TD>
        <TD>int</TD>
        <TD>A socket that listens for LPD protocol connections.</TD>
    </TR>
    <TR>
        <TD>RemoteSockets</TD>
        <TD>lpd_t [MAX_LPD]</TD>
        <TD>Incoming/outgoing print jobs via LPD protocol.</TD>
    </TR>
    <TR>
        <TD>NumRemoteSockets</TD>
        <TD>int</TD>
        <TD>Number of LPD connections.</TD>
    </TR>
</TABLE>
</CENTER>
<H3>
CommandProcessing()</H3>
<H4>
do_add_printer()</H4>
<H4>
do_get_default_options()</H4>
<H4>
do_get_ppd_file()</H4>
<H4>
do_get_printer_list()</H4>
<H4>
do_get_printer_status()</H4>
<H4>
do_get_queue_status()</H4>
<H4>
do_query_printer()</H4>
<H4>
do_queue_file()</H4>
<H4>
do_remove_printer()</H4>
<H4>
do_requeue_file()</H4>
<H4>
do_set_default_options()</H4>
<H4>
do_set_printer_status()</H4>
<H4>
do_unqueue_file()</H4>
<H4>
do_update_printer()</H4>
<H3>
LocalProcessing()</H3>
<H4>
close_device()</H4>
<H4>
find_next_job()</H4>
<H4>
finish_job()</H4>
<H4>
open_device()</H4>
<H4>
scan_devices()</H4>
<H4>
start_job()</H4>
<H3>
RemoteProcessing()</H3>
<H4>
accept_connection()</H4>
<H4>
make_connection()</H4>
<H4>
receive_control_file()</H4>
<H4>
receive_job_file()</H4>
<H4>
send_control_file()</H4>
<H4>
send_job_file()</H4>
<H3>
NetworkProcessing()</H3>
<H4>
get_message()</H4>
<H4>
add_printer()</H4>
<H4>
remove_printer()</H4>
<H4>
update_printer()</H4>
<H4>
add_server()</H4>
<H2>
Interface Library</H2>
<H3>
cupsAddPrinter()</H3>
<H3>
cupsCheckPage()</H3>
<H3>
cupsChoosePPDOption()</H3>
<H3>
cupsChoosePPDOptions()</H3>
<H3>
cupsClearPageList()</H3>
<H3>
cupsClose()</H3>
<H3>
cupsGetDefaultOptions()</H3>
<H3>
cupsGetError()</H3>
<H3>
cupsGetErrorString()</H3>
<H3>
cupsGetMessage()</H3>
<H3>
cupsGetPageList()</H3>
<H3>
cupsGetPPDFile()</H3>
<H3>
cupsGetPrinterAccess()</H3>
<H3>
cupsGetPrinterList()</H3>
<H3>
cupsGetPrinterStatus()</H3>
<H3>
cupsGetQueueStatus()</H3>
<H3>
cupsLogPage()</H3>
<H3>
cupsOpen()</H3>
<H3>
cupsQueryPrinter()</H3>
<H3>
cupsQueueFile()</H3>
<H3>
cupsRemovePrinter()</H3>
<H3>
cupsRequeueFile()</H3>
<H3>
cupsSendMessage()</H3>
<H3>
cupsSetDefaultOptions()</H3>
<H3>
cupsSetPrinterAccess()</H3>
<H3>
cupsSetPrinterStatus()</H3>
<H3>
cupsUnqueueFile()</H3>
<H3>
cupsUpdatePrinter()</H3>
<H3>
cupsWritePPDOptions()</H3>
<H2>
Manager</H2>
<H2>
Status</H2>
<H2>
Control</H2>
<H2>
Queue</H2>
<H2>
Option Panel</H2>
<H2>
Text Filter</H2>
<H2>
Image Filter</H2>
<H2>
PostScript Filter</H2>
<H2>
HPGL Filter</H2>

<H1 TYPE="A" VALUE="1">Glossary</H1>

<H2>Acronyms</H2>

<DL>
	<DT>ASCII
	<DD>American Standard Code for Information Interchange

	<DT>CUPS
	<DD>Common UNIX Printing System

	<DT>ESC/P
	<DD>EPSON Standard Code for Printers

	<DT>HP-GL
	<DD>Hewlett-Packard Graphics Language

	<DT>HP-PCL
	<DD>Hewlett-Packard Printer Control Language

	<DT>HP-PJL
	<DD>Hewlett-Packard Printer Job Language

	<DT>IPP
	<DD>Internet Printing Protocol

	<DT>ISO
	<DD>International Standards Organization

	<DT>LPD
	<DD>Line Printer Daemon

	<DT>MIME
	<DD>Multimedia Internet Mail Exchange

	<DT>PCL
	<DD>Page Control Language

	<DT>PPD
	<DD>PostScript Printer Description
</DL>

</BODY>
</HTML>
